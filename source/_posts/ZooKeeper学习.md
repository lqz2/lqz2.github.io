---
title: ZooKeeper学习
date: 2025-06-03 10:49:27
categories: 学习
math:
tags:
---
<!-- TOC -->

- [ZooKeeper学习](#zookeeper学习)
    - [ZooKeeper简介](#zookeeper简介)
    - [分布式环境下的数据协调问题](#分布式环境下的数据协调问题)
    - [一致性协议和算法](#一致性协议和算法)
        - [二阶段提交协议（2PC）](#二阶段提交协议2pc)
        - [三阶段提交协议（3PC）](#三阶段提交协议3pc)
        - [Paxos算法](#paxos算法)

<!-- /TOC -->
# ZooKeeper学习
## ZooKeeper简介
ZooKeeper是一个开源的分布式协调服务框架，其一致性是通过基于 Paxos 算法的 ZAB 协议完成的。其主要功能包括：配置维护、分布式同步、集群管理等。
## 分布式环境下的数据协调问题
- 分布式环境下，无法保证顺序：单机环境下A和B的顺序是由调用顺序决定的，而在分布式环境下，A和B的顺序可能会因为网络延迟等因素而改变。
- 分布式环境下，无法明确执行结果：分布式环境下，A即使执行成功了，如果网络传输超时了，也无法判断A是否执行成功。
- 分布式环境下，无法保证数据一致性：分布式环境下，多个节点可能会同时修改同一份数据，导致数据不一致。

## 一致性协议和算法
### 二阶段提交协议（2PC）
一种分布式事务协议，分为准备（投票）阶段和提交（执行）阶段。
投票阶段：
1. 协调者向所有参与者发送prepare请求，通知参与者执行事务
2. 参与者收到请求后，执行事务并记录undo日志和redo日志，但不提交事务
3. 参与者向协调者发送事务执行结果（Yes或者No）

提交阶段：
1. 如果所有参与者都返回yes，协调者向所有参与者发送commit请求，通知参与者提交事务，参与者提交事务并返回ack给协调者
2. 如果有参与者返回no，协调者向所有参与者发送rollback请求，通知参与者回滚事务，参与者根据undo日志回滚事务并返回ack给协调者

存在的问题：
1. 容错低，有一个参与者挂了，整个事务就无法完成
2. 性能低，同步期间所有资源被锁定，资源利用率低
3. 数据不一致，协调者发送commit命令期间挂了，有的参与者提交了事务，有的没有提交。

### 三阶段提交协议（3PC）
在2PC的基础上增加了一个选票预收集阶段，分为预投票、投票和提交三个阶段。
- 预投票阶段：协调者向所有参与者发送请求，询问是否可以执行事务，参与者根据自身状态返回Yes或No。
- 投票阶段：如果所有参与者都返回Yes，协调者向所有参与者发送prepare请求，参与者执行事务并记录undo日志和redo日志；如果有参与者返回No，协调者向所有参与者发送中断请求，中断事务。
- 提交阶段：流程和2PC类似

3PC仍然没有解决一致性问题

### Paxos算法




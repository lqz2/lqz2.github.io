---
title: 暑期整理
date: 2025-07-05 20:02:46
categories: 学习
math:
tags:
---

<!-- TOC -->

- [分布式模型评测平台](#分布式模型评测平台)
    - [简介](#简介)
    - [关键模块](#关键模块)
        - [调度方式](#调度方式)
            - [旧版调度方式](#旧版调度方式)
            - [新版调度方式](#新版调度方式)

<!-- /TOC -->
# 分布式模型评测平台

## 简介
该平台主要用于将业务数据批量上传给大模型，通过大模型的能力完成判断是否存在违规行为、责任划分等业务内容，同时还可以根据大模型的返回结果，制定相应的评测规则，对大模型的判断结果进行打分，评价大模型的业务能力，平台的主要功能包括数据导入、任务创建、模型评测、工作流评测、自定义评测规则、结果导出等，可服务于企业内部多种业务需求。

## 关键模块
### 调度方式
#### 旧版调度方式
旧版调度模式下，主要的工作流程如下：
1. 新建评测任务
2. 定时任务扫描到新建的任务，然后开始处理
3. 处理每个任务时，首先可以从在线数据源中或者本地上传的评测集中获取数据，通过获取的数据构建众多tasks,然后将这些task写入到数据库中
4. 接下来，从模型的维度将task的id通过lpush添加到redis队列，其中redis的key是通过`modelName+index`设置的，index是模型对应的队列
5. 在应用启动时，会给模型评测的Diamond配置增加一个监听器，监听对应配置变更，当配置变化时，会给配置里的每个模型启动2个工作线程，提交到线程池，具体来说，实际上是一个模型对应2个redis队列，然后通过2个工作线程，分别从对应redis队列取出task来处理，也就是一个线程处理一个redis队列的tasks
6. 工作线程取出task后，先尝试获取锁，这里获取锁是主要通过一个lua脚本限流，因为大模型的api通常是有调用频率限制的，这里评测的数据可能很多，调用时需要限流。获取到锁之后，向对应模型发送请求，并获取请求结果，如果请求失败则进行3～5次的重试，请求成功后，将task结果更新到数据库中。

**存在的问题**：
旧版的调度方式下，一个模型默认分配两个队列，并且由两个工作线程处理，如果多个用户同时创建任务，可能会导致某个模型的队列排队的task过多，导致一些用户的任务长时间得不到处理。

#### 新版调度方式
新版调度方式与旧版调度方式相比，主要的区别在于，新版的调度方式中，redis队列的key是`modelName+AK`，并且通过zookeeper对资源节点进行监听，每个






